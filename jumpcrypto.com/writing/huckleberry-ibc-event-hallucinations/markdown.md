[](/)

  * Building 
    * [Firedancer](/firedancer/)
    * [the Pit](/thepit/)
    * [Cyclone](/cyclone/)
  * Thinking 
    * [Writing](/writing/)
    * [Research](/research/)
  * [Connect](/connect/)

  * [Building](/)
    * [Firedancer](/firedancer/)
    * [the Pit](/thepit/)
    * [Cyclone](/cyclone/)
    * [Collaborations](/collaborations/)
  * [Thinking](/writing/)
    * [Writing](/writing/)
    * [Research](/research/)
    * [Media](/media/)
  * [About](/writing/)
    * [Chronicle](/chronicle/)
    * [Validator](/validator-security/)
    * [Brand & Press](/brand/)
    * [Connect](/connect/)

[](https://twitter.com/jump_)[](https://github.com/JumpCrypto)[](https://www.youtube.com/@jump_)

[Terms of Use_](/terms-of-use/)[Privacy Policy_](/data-protection-and-privacy-
policy/)[Disclaimers_](/nfa/)

![](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM2NSIgaGVpZ2h0PSI3MTEiIHZpZXdCb3g9IjAgMCAxMzY1IDcxMSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgb3BhY2l0eT0iMC4zIj4KPHJlY3QgeT0iOTIuNzM5MSIgd2lkdGg9IjE0Mi45NzMiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSIxNzMuODg2IiB5PSIyNzguMjE4IiB3aWR0aD0iNDYzLjY5NiIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxwYXRoIGQ9Ik0xNzMuODg2IDM3MC45NTZINDQwLjUxMVY0MzIuNzgySDE3My44ODZWMzcwLjk1NloiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iMTczLjg4NiIgeT0iNDYzLjY5NiIgd2lkdGg9IjM3OC42ODUiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSIxNzMuODg2IiB5PSI5Mi43MzkxIiB3aWR0aD0iNDg2Ljg4IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iNjY3LjI2IiB5PSIyNzguNDkyIiB3aWR0aD0iNDA1LjczNCIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjQ3MS40MjUiIHk9IjM3MC45NTYiIHdpZHRoPSI1MTAuMDY1IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iMTAxMi40IiB5PSIzNzAuOTU2IiB3aWR0aD0iMjgyLjA4MiIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjkyLjczOTMiIHk9IjE4NS40NzgiIHdpZHRoPSI0MDUuNzM0IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iOTIuNzM5MyIgeT0iNTU2LjQzNSIgd2lkdGg9IjIzOS41NzYiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI1ODMuNDgzIiB5PSI0NjMuNjk2IiB3aWR0aD0iMjg1Ljk0NiIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjkwMC44MDIiIHk9IjQ2My42MzEiIHdpZHRoPSIxNjIuMjEzIiBoZWlnaHQ9IjYyLjEyNDIiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iNjkxLjY4MSIgeT0iOTIuNzM5MSIgd2lkdGg9IjI5Ny41MzgiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI1OTguOTQiIHk9IjE4NS40NzgiIHdpZHRoPSIyOTcuNTM4IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iMTAyMC40NSIgeT0iOTMuMTg2MyIgd2lkdGg9IjI3My44MDciIGhlaWdodD0iNjAuOTczOCIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI5OTYuOTQ2IiB5PSIxODUuNDc4IiB3aWR0aD0iMjk3LjUzOCIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjEwOTMuNzkiIHk9IjQ2My4xNDQiIHdpZHRoPSIzOC42NDEzIiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iNTI5LjM4NiIgeT0iMTg1LjQ3OCIgd2lkdGg9IjM4LjY0MTMiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI5MjcuMzkxIiB5PSIxODUuNDc4IiB3aWR0aD0iMzguNjQxMyIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjEzMjUuNCIgeT0iMTg1LjQ3OCIgd2lkdGg9IjM4LjY0MTMiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSIzNjMuMjI4IiB5PSI1NTYuNDM1IiB3aWR0aD0iMzguNjQxMyIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHk9IjY0OS4xNzQiIHdpZHRoPSIzOC42NDEzIiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3Qgd2lkdGg9IjE0MyIgaGVpZ2h0PSI2MiIgZmlsbD0iIzBFMjE0NyIvPgo8L2c+Cjwvc3ZnPgo=)

# Huckleberry: IBC Event Hallucinations

![Felix Wilhelm](https://jumpcrypto-com.ghost.io/content/images/2023/02/image
--202-.jpg)

###### Felix Wilhelm

[Security](/writing/security/)

Sep 06 2023 _ 4 min read

![Huckleberry: IBC Event Hallucinations](https://jumpcrypto-
com.ghost.io/content/images/2023/09/New-Blog-Post.png)

This blog post describes a vulnerability in [ibc-
go](https://github.com/cosmos/ibc-go?ref=jumpcrypto.com), the reference
implementation of the Interblockchain Communication Protocol (IBC) used by
most Cosmos blockchains. The issue can lead to the incorrect emission of
Cosmos events triggered by a rolled-back IBC transfer. We privately disclosed
the vulnerability to the Cosmos team, the fix with the codename
[Huckleberry](https://forum.cosmos.network/t/ibc-security-advisory-
huckleberry/10731?ref=jumpcrypto.com) got released in May and there is no
indication that any malicious exploitation took place.

As part of our efforts as builders, researchers, and collaborators in the
crypto space, one of our goals at Jump Crypto is to improve security assurance
across the entire ecosystem. Our specialized security team has ongoing
research efforts dedicated to discovering and patching vulnerabilities across
projects via [coordinated
disclosure](https://en.wikipedia.org/wiki/Coordinated_vulnerability_disclosure?ref=jumpcrypto.com).
This announcement once again brings these efforts to light.

## Cosmos Events

Similar to Ethereum log events, Cosmos events offer an easy way for offchain
applications to monitor the execution of a Cosmos chain. Although the
blockchain state is the authoritative source of information, events enable
efficient monitoring.

For instance, consider a token transfer on a Cosmos chain: A successful
transaction that contains a `MsgSend` message will initiate a transfer of
`Coins` from the sender's account to the recipient's. The primary outcome of
this transfer is the modification of the two account states. In addition, a
[bank transfer event](https://github.com/cosmos/cosmos-
sdk/blob/aabcfb2aa03391f457459d6494722f3a3592aefa/x/bank/keeper/send.go?ref=jumpcrypto.com#L180)
will be emitted.

Events emitted during the processing of a transaction are included in
[TxResponse](https://github.com/cosmos/cosmos-
sdk/blob/aabcfb2aa03391f457459d6494722f3a3592aefa/proto/cosmos/base/abci/v1beta1/abci.proto?ref=jumpcrypto.com#L49).
Moreover, the Cosmos RPC API makes it possible to
[subscribe](https://docs.cosmos.network/main/core/events?ref=jumpcrypto.com#subscribing-
to-events) to specific events using a fully-featured query language.  Offchain
applications can passively ingest onchain activity using these mechanisms.
Centralized exchanges and bridges are the most interesting users from a
security perspective, as they can use events to monitor interactions with
their deposit wallets or bridging contracts.

It is important that state changes and event emissions are always in sync and
that failed transactions should not emit any events. Otherwise, an offchain
application can be tricked into processing an operation that was never
persisted.

As it turns out, this invariant was broken in all Cosmos chains with IBC
support, due to an incorrect error handling mechanism in ibc-go’s
`OnRecvPacket` function.

## IBC Packet Handling

IBC packets are the basic building block of IBC. When a relayer submits a
packet originating from a connected chain to the target chain by sending a
[`MsgRecvPacket`](https://github.com/cosmos/ibc-
go/blob/4e0bea725d57e0eec2ea485d2e8aa3085bc7079f/proto/ibc/core/channel/v1/tx.proto?ref=jumpcrypto.com#L178)
message, its data is first authenticated and then delivered to the
corresponding application module via the `OnRecvPacket` callback. Unlike most
other Cosmos functions, `OnRecvPacket` does not handle issues by returning an
optional Golang error.

Instead, it returns an IBC acknowledgment. A successful acknowledgment means
that the IBC packet was processed correctly, while a failed acknowledgment
means the opposite. However, regardless of the result, the overall transaction
will still succeed. This makes it possible to persist the acknowledgment
result on-chain and relay it back to the sender chain.

As it turns out, this invariant was broken in all Cosmos chains with IBC
support, due to an incorrect error handling mechanism in ibc-go’s
`OnRecvPacket` function.

    
    
    //https://github.com/cosmos/ibc-go/blob/9c1a81d09025014e1e4bb6fe369f76f0bc463102/modules/core/keeper/msg_server.go#L410
    func (k Keeper) RecvPacket(goCtx context.Context, msg *channeltypes.MsgRecvPacket) (*channeltypes.MsgRecvPacketResponse, error) {
      
      [...]
      // Perform application logic callback
    	//
    	// Cache context so that we may discard state changes from callback if the acknowledgement is unsuccessful.
    	cacheCtx, writeFn = ctx.CacheContext()
    	ack := cbs.OnRecvPacket(cacheCtx, msg.Packet, relayer)
    	if ack == nil || ack.Success() {
    		// write application state changes for asynchronous and successful acknowledgements
    		writeFn()
    	} else {
    		// NOTE: The context returned by CacheContext() refers to a new EventManager, so it needs to explicitly set events to the original context.
    		// Events should still be emitted from failed acks and asynchronous acks
    		ctx.EventManager().EmitEvents(cacheCtx.EventManager().Events())
    	}

In the happy path, a successful acknowledgment is returned, state changes are
committed, and events are emitted. In the error path, no state changes are
committed but all generated events are still emitted.

This means that events generated during an IBC packet receive callback can end
up in the final transaction results, even though their corresponding state
changes are not persisted on chain.

## Exploiting Hallucinations

An attacker who wishes to exploit these incorrect event emissions must
identify a target that trusts events for sensitive actions. Then, they need to
find a way to trigger the relevant events during the processing of an IBC
packet, which will return a negative acknowledgment.

Triggering a negative acknowledgment after emitting security sensitive events
is easy on chains that support arbitrary
[Cosmwasm](https://github.com/CosmWasm/cosmwasm?ref=jumpcrypto.com) contracts:
An attacker can create a malicious smart contract that implements the [IBC
interface](https://github.com/CosmWasm/cosmwasm/blob/main/IBC.md?ref=jumpcrypto.com).
Whenever the contract receives an IBC packet, it creates sub messages to
perform sensitive actions such as triggering a bridge transfer. Regardless of
this, it always return an Error acknowledgment. Exploitation without a WASM
runtime is more difficult, but still possible if a chain uses IBC modules that
can trigger security sensitive events like a Bank transfers before returning
an error acknowledgment.

As mentioned earlier, two security sensitive examples of offchain applications
that rely on Cosmos events are centralized exchanges and bridges.

Exchanges can use events to monitor for transfers to their deposit wallets.
Thanks to Cosmos instant finality and the normal guarantees around Event
emissions, a single transfer event to an exchange wallet would normally be
sufficient to confirm a deposit. By abusing the bug described above an
attacker could trigger repeated deposit events without losing control of the
tokens.  As CEX codebases are closed source and an exchange might implement
additional verification steps that protect against this attack, we were not
able to verify which exchanges were vulnerable to this attack. However, we are
aware of multiple exchanges halting deposits on Cosmos chains around the time
of this disclosure.

Fortunately, multiple **bridges** that support Cosmos networks have partially
open-source offchain implementations, which allows us to verify the impact of
this bug without performing any visible onchain experiments. cBridge,
Multichain and Wormhole’s legacy Cosmos integration (replaced by the IBC-
native Wormhole Gateway) all depend on Cosmos events for detecting
interactions with their smart contracts or deposit wallets, making them
vulnerable to this issue.

## Patch

The [patch](https://github.com/cosmos/ibc-
go/commit/4973957900d70969d99371e6ed24c47400f5abe6?ref=jumpcrypto.com) for
Huckleberry is simple. Don’t emit events for failed acknowledgments.

## Conclusion

Vulnerabilities such as Huckleberry, which break core assumptions of offchain
components, can lead to a wide range of unexpected security vulnerabilities in
various products. These vulnerabilities clearly demonstrate the need for
robust defense-in-depth mitigations in web3 applications.

Share

![](/static/subscribe2-825809a798c6960f978785c6581f4afb.svg)

#### Stay up to date with the latest from Jump_

​

.Subscribe

#### More articles

![SAFU: Creating a Standard for Whitehats](https://jumpcrypto-
com.ghost.io/content/images/2022/10/Standards-for-Whitehats-Thread---
blog.png)SAFU: Creating a Standard for WhitehatsWhitehats and DeFi protocols
need a shared understanding of security policy. We propose the SAFU - Simple
Arrangement for Funding Upload - as a versatile and credible way to let
whitehats know what to...](/writing/safu-creating-a-standard-for-whitehats/)

Oct 24 2022 _ 17 min

Share

[![Mapping Markets: Evaluating Blockchain’s Mass Adoption
Potential](https://jumpcrypto-com.ghost.io/content/images/2023/06/Blog---
Mapping-Markets_-Evaluating-Blockchain-s-Mass-Adoption-Potential.png)Mapping
Markets: Evaluating Blockchain’s Mass Adoption PotentialIn this post, we
propose a geographically-oriented framework, which we call “Pueyo Maps”
(inspired by Tomas Pueyo’s geo-history), as a way of evaluating the long-term
suitability of blockchain-based s...](/writing/mapping-markets-blockchain-
mass-adoption-potential/)

Jun 05 2023 _ 20 min

Share

[![Stop the Chain! CosmWasm Stack Overflow](https://jumpcrypto-
com.ghost.io/content/images/2023/06/blog_cosmwasm_security.png)Stop the Chain!
CosmWasm Stack OverflowThis post announces a vulnerability we discovered in
CosmWasm, a smart contract platform written for the Cosmos ecosystem. The
vulnerability was a stack overflow, which would have allowed users who
ca...](/writing/stop-the-chain-cosmwasm-stack-overflow/)

Jun 01 2023 _ 1 min

Share

Disclaimer

The information on this website and on the Brick by Brick podcast or Ship Show
Twitter spaces is provided for informational, educational, and entertainment
purposes only.  This information is not intended to be and does not constitute
financial advice, investment advice, trading advice, or any other type of
advice.  You should not make any decision – financial, investment, trading or
otherwise – based on any of the information presented here without undertaking
your own due diligence and consulting with a financial adviser.  Trading,
including that of digital assets or cryptocurrency, has potential rewards as
well as potential risks involved. Trading may not be suitable for all
individuals. Recordings of podcast episodes or Twitter spaces events may be
used in the future.

![](data:image/svg+xml;charset=utf-8,%3Csvg height='619' width='1338'
xmlns='http://www.w3.org/2000/svg' version='1.1'%3E%3C/svg%3E)

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAD0lEQVQoz2NgGAWjYBgCAALZAAHP5sSUAAAAAElFTkSuQmCC)![](/static/bb55dfe76137757a150d8db409a314e1/80e7e/brandLines.svg)

###### Building_

  * [Firedancer](/firedancer/)
  * [the Pit](/thepit/)
  * [Cyclone](/cyclone/)

###### Thinking_

  * [Writing](/writing/)
  * [Research](/research/)

###### About_

  * [Validator Security](/validator-security/)
  * [Connect](/connect/)

[Terms of Use_](/terms-of-use/)[Privacy Policy_](/data-protection-and-privacy-
policy/)[Disclaimers_](/nfa/)

© 2024 Jump Crypto. All Rights Reserved.

Jump Crypto does not operate any business lines that accept funds from
external investors. Any person, company, or app purporting to accept external
investor funds on behalf of Jump Crypto is fraudulent.

